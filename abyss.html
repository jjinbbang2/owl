<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–´ë¹„ìŠ¤ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­</title>

    <meta name="description" content="ë¶€ì—‰ê³µí™”êµ­ ì–´ë¹„ìŠ¤ ë˜ì „ íŒŒí‹° ëª¨ì§‘ ê²Œì‹œíŒì…ë‹ˆë‹¤.">
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <meta property="og:title" content="ì–´ë¹„ìŠ¤ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­">
    <meta property="og:image" content="https://jjinbbang2.github.io/owl/og-image.png">
    <meta name="theme-color" content="#4a3728">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="./styles.css?v=2025120802">
    <style>
        .party-card {
            background: rgba(26, 27, 38, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .party-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        .party-schedule {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-gold);
        }
        .party-difficulty {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .party-count {
            background: rgba(122, 162, 247, 0.2);
            color: var(--accent-blue);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .members-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .member-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .member-nickname {
            flex: 1;
            font-weight: 500;
        }
        .member-role {
            display: flex;
            gap: 8px;
        }
        .role-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .role-tanker {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        .role-healer {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        .btn-delete {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-delete:hover {
            background: rgba(248, 113, 113, 0.4);
        }
        .add-form {
            background: rgba(26, 27, 38, 0.95);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .form-title {
            color: var(--primary-gold);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 150px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.85rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-size: 0.95rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-gold);
        }
        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-light);
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .btn-submit {
            background: linear-gradient(145deg, var(--primary-gold), #b8960b);
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
        }
        .btn-add-party {
            background: rgba(122, 162, 247, 0.2);
            color: var(--accent-blue);
            border: 1px dashed var(--accent-blue);
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        .btn-add-party:hover {
            background: rgba(122, 162, 247, 0.3);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .hidden {
            display: none;
        }
        /* Flatpickr ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .flatpickr-calendar {
            background: rgba(26, 27, 38, 0.98) !important;
            border: 1px solid rgba(212, 175, 55, 0.3) !important;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5) !important;
        }
        .flatpickr-day.selected {
            background: var(--primary-gold) !important;
            border-color: var(--primary-gold) !important;
            color: #000 !important;
        }
        .flatpickr-day:hover {
            background: rgba(212, 175, 55, 0.3) !important;
        }
        .flatpickr-time input {
            background: rgba(0, 0, 0, 0.3) !important;
            color: var(--text-light) !important;
        }
        .flatpickr-time .flatpickr-am-pm {
            background: rgba(0, 0, 0, 0.3) !important;
            color: var(--text-light) !important;
        }
        .schedule-input {
            cursor: pointer !important;
        }
        .party-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .btn-add-member {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-add-member:hover {
            background: rgba(74, 222, 128, 0.3);
        }
        .btn-delete-party {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        .btn-share {
            background: rgba(250, 225, 0, 0.2);
            color: #fae100;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        .btn-share:hover {
            background: rgba(250, 225, 0, 0.3);
        }
        .add-member-form {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
    </style>
</head>
<body>
<nav class="nav">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">ğŸ¦‰</a>
        <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
        <ul class="nav-menu" id="navMenu">
            <li><a href="index.html">ë­í‚¹</a></li>
            <li><a href="guide.html">ì´ìš©ì•ˆë‚´</a></li>
            <li><a href="abyss.html" class="active">ì–´ë¹„ìŠ¤</a></li>
            <li><a href="abyss-help.html">í’ˆì•—ì´</a></li>
            <li><a href="raid.html">ë ˆì´ë“œ</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <header class="header">
        <div class="header-emblem">ğŸŒ€</div>
        <h1 class="header-title">ì–´ë¹„ìŠ¤ íŒŒí‹°</h1>
        <p class="header-subtitle">ì–´ë¹„ìŠ¤ ë˜ì „ íŒŒí‹° ëª¨ì§‘</p>
    </header>

    <section>
        <!-- ìƒˆ íŒŒí‹° ìƒì„± í¼ -->
        <button class="btn-add-party" onclick="toggleNewPartyForm()">+ ìƒˆ íŒŒí‹° ë§Œë“¤ê¸°</button>

        <div id="newPartyForm" class="add-form hidden">
            <h3 class="form-title">ìƒˆ íŒŒí‹° ìƒì„±</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>ìš”ì¼Â·ì‹œê°„</label>
                    <input type="text" id="newSchedule" class="schedule-input" placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" readonly>
                </div>
                <div class="form-group">
                    <label>ë‚œì´ë„</label>
                    <select id="newDifficulty">
                        <option value="ì…ë¬¸">ì…ë¬¸</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                        <option value="ë§¤ìš° ì–´ë ¤ì›€" selected>ë§¤ìš° ì–´ë ¤ì›€</option>
                        <option value="ì§€ì˜¥ 1">ì§€ì˜¥ 1</option>
                        <option value="ì§€ì˜¥ 2">ì§€ì˜¥ 2</option>
                        <option value="ì§€ì˜¥ 3">ì§€ì˜¥ 3</option>
                        <option value="ì§€ì˜¥ 4">ì§€ì˜¥ 4</option>
                        <option value="ì§€ì˜¥ 5">ì§€ì˜¥ 5</option>
                        <option value="ì§€ì˜¥ 6">ì§€ì˜¥ 6</option>
                        <option value="ì§€ì˜¥ 7">ì§€ì˜¥ 7</option>
                        <option value="ì§€ì˜¥ 8">ì§€ì˜¥ 8</option>
                        <option value="ì§€ì˜¥ 9">ì§€ì˜¥ 9</option>
                        <option value="ì§€ì˜¥ 10">ì§€ì˜¥ 10</option>
                    </select>
                </div>
            </div>
            <h4 style="color: #888; margin: 15px 0 10px; font-size: 0.9rem;">ì²« ë²ˆì§¸ ì°¸ê°€ì (ë³¸ì¸)</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>ë‹‰ë„¤ì„</label>
                    <input type="text" id="newNickname" placeholder="ìºë¦­í„° ë‹‰ë„¤ì„">
                </div>
                <div class="form-group">
                    <label>ì—­í• </label>
                    <div class="checkbox-group" style="margin-top: 8px;">
                        <label><input type="checkbox" id="newTanker"> íƒ±ì»¤</label>
                        <label><input type="checkbox" id="newHealer"> íëŸ¬</label>
                    </div>
                </div>
            </div>
            <button class="btn-submit" onclick="createParty()">íŒŒí‹° ìƒì„±</button>
        </div>

        <!-- íŒŒí‹° ëª©ë¡ -->
        <div id="partyList">
            <div class="empty-state">
                <p>íŒŒí‹° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script src="./js/supabase-config.js"></script>
<script>
// ìš”ì¼ ë°°ì—´
const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

// ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜: "2025-12-08 21:30(ì›”)" í˜•ì‹
function formatSchedule(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    const dayName = dayNames[date.getDay()];
    return `${year}-${month}-${day} ${hour}:${minute}(${dayName})`;
}

// ë§Œë£Œëœ íŒŒí‹° ì‚­ì œ (ëª¨ì§‘ ì‹œê°„ + 3ì‹œê°„ ì§€ë‚œ íŒŒí‹°)
async function deleteExpiredParties() {
    const threeHoursAgo = new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString();

    const { error } = await supabase
        .from('abyss_parties')
        .delete()
        .lt('schedule', threeHoursAgo);

    if (error) {
        console.error('ë§Œë£Œ íŒŒí‹° ì‚­ì œ ì‹¤íŒ¨:', error);
    }
}

// ë‚¨ì€ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
function getTimeRemaining(targetDate) {
    const now = new Date();
    const diff = targetDate - now;

    if (diff <= 0) {
        return '<span style="color: #f87171;">ì¢…ë£Œë¨</span>';
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    if (days > 0) {
        return `<span style="color: #4ade80;">${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ</span>`;
    } else if (hours > 0) {
        return `<span style="color: #fbbf24;">${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ</span>`;
    } else {
        return `<span style="color: #f87171;">${minutes}ë¶„ ë‚¨ìŒ</span>`;
    }
}

// Flatpickr ì´ˆê¸°í™”
let schedulePicker;
let selectedScheduleDate = null; // datetime ì €ì¥ìš©
let currentParties = []; // íŒŒí‹° ëª©ë¡ ì €ì¥ìš©

function initSchedulePicker() {
    schedulePicker = flatpickr("#newSchedule", {
        locale: "ko",
        enableTime: true,
        noCalendar: false,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minuteIncrement: 30,
        defaultHour: 21,
        minDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length > 0) {
                selectedScheduleDate = selectedDates[0]; // datetime ì €ì¥
                instance.element.value = formatSchedule(selectedDates[0]);
            }
        }
    });
}

// íŒŒí‹° ëª©ë¡ ë¡œë“œ
async function loadParties() {
    const { data: parties, error } = await supabase
        .from('abyss_parties')
        .select(`
            *,
            abyss_members (*)
        `)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error loading parties:', error);
        document.getElementById('partyList').innerHTML = `
            <div class="empty-state">
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 0.85rem; margin-top: 10px;">${error.message}</p>
            </div>
        `;
        return;
    }

    currentParties = parties || [];
    renderParties(parties);
}

// íŒŒí‹° ëª©ë¡ ë Œë”ë§
function renderParties(parties) {
    const container = document.getElementById('partyList');

    if (!parties || parties.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>ì•„ì§ ë“±ë¡ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 0.85rem; margin-top: 10px;">ìƒˆ íŒŒí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = parties.map(party => {
        // datetimeì„ í¬ë§·íŒ…í•´ì„œ í‘œì‹œ
        const scheduleDate = party.schedule ? new Date(party.schedule) : null;
        const scheduleDisplay = scheduleDate ? formatSchedule(scheduleDate) : '-';
        const timeRemaining = scheduleDate ? getTimeRemaining(scheduleDate) : '';
        return `
        <div class="party-card" id="party-${party.id}" data-schedule="${party.schedule || ''}">
            <div class="party-header">
                <div>
                    <span class="party-schedule">${scheduleDisplay}</span>
                    <span class="time-remaining" style="margin-left: 10px; font-size: 0.85rem;">${timeRemaining}</span>
                </div>
                <div>
                    <span class="party-count">${party.abyss_members.length}/4</span>
                    <span class="party-difficulty">${party.difficulty || 'ë§¤ìš° ì–´ë ¤ì›€'}</span>
                </div>
            </div>
            <div class="members-list">
                ${party.abyss_members.map(member => `
                    <div class="member-row">
                        <span class="member-nickname">${member.nickname}</span>
                        <div class="member-role">
                            ${member.is_tanker ? '<span class="role-badge role-tanker">íƒ±ì»¤</span>' : ''}
                            ${member.is_healer ? '<span class="role-badge role-healer">íëŸ¬</span>' : ''}
                        </div>
                        <button class="btn-delete" onclick="deleteMember('${member.id}')">ì‚­ì œ</button>
                    </div>
                `).join('')}
            </div>
            <div class="party-actions">
                ${party.abyss_members.length < 4
                    ? `<button class="btn-add-member" onclick="toggleAddMemberForm('${party.id}')">+ ì°¸ê°€í•˜ê¸°</button>`
                    : '<span style="color: #4ade80; font-size: 0.85rem;">íŒŒí‹° ëª¨ì§‘ ì™„ë£Œ!</span>'}
                <button class="btn-share" onclick="copyPartyInfo('${party.id}')">ê³µìœ </button>
                <button class="btn-delete-party" onclick="deleteParty('${party.id}')">íŒŒí‹° ì‚­ì œ</button>
            </div>
            <div id="addMemberForm-${party.id}" class="add-member-form hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>ë‹‰ë„¤ì„</label>
                        <input type="text" id="memberNickname-${party.id}" placeholder="ìºë¦­í„° ë‹‰ë„¤ì„">
                    </div>
                    <div class="form-group">
                        <label>ì—­í• </label>
                        <div class="checkbox-group" style="margin-top: 8px;">
                            <label><input type="checkbox" id="memberTanker-${party.id}"> íƒ±ì»¤</label>
                            <label><input type="checkbox" id="memberHealer-${party.id}"> íëŸ¬</label>
                        </div>
                    </div>
                </div>
                <button class="btn-submit" onclick="addMember('${party.id}')" style="padding: 8px 20px; font-size: 0.9rem;">ì°¸ê°€</button>
            </div>
        </div>
    `;
    }).join('');
}

// ìƒˆ íŒŒí‹° í¼ í† ê¸€
function toggleNewPartyForm() {
    document.getElementById('newPartyForm').classList.toggle('hidden');
}

// ë©¤ë²„ ì¶”ê°€ í¼ í† ê¸€
function toggleAddMemberForm(partyId) {
    document.getElementById(`addMemberForm-${partyId}`).classList.toggle('hidden');
}

// íŒŒí‹° ìƒì„±
async function createParty() {
    const difficulty = document.getElementById('newDifficulty').value;
    const nickname = document.getElementById('newNickname').value.trim();
    const isTanker = document.getElementById('newTanker').checked;
    const isHealer = document.getElementById('newHealer').checked;

    if (!selectedScheduleDate || !nickname) {
        alert('ìš”ì¼Â·ì‹œê°„ê³¼ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // datetimeì„ ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const schedule = selectedScheduleDate.toISOString();

    // íŒŒí‹° ìƒì„±
    const { data: party, error: partyError } = await supabase
        .from('abyss_parties')
        .insert({ schedule, difficulty })
        .select()
        .single();

    if (partyError) {
        alert('íŒŒí‹° ìƒì„± ì‹¤íŒ¨: ' + partyError.message);
        return;
    }

    // ì²« ë²ˆì§¸ ë©¤ë²„ ì¶”ê°€
    const { error: memberError } = await supabase
        .from('abyss_members')
        .insert({
            party_id: party.id,
            nickname,
            is_tanker: isTanker,
            is_healer: isHealer
        });

    if (memberError) {
        alert('ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + memberError.message);
        return;
    }

    // í¼ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
    schedulePicker.clear();
    selectedScheduleDate = null;
    document.getElementById('newNickname').value = '';
    document.getElementById('newTanker').checked = false;
    document.getElementById('newHealer').checked = false;
    document.getElementById('newPartyForm').classList.add('hidden');

    loadParties();
}

// ë©¤ë²„ ì¶”ê°€
async function addMember(partyId) {
    const nickname = document.getElementById(`memberNickname-${partyId}`).value.trim();
    const isTanker = document.getElementById(`memberTanker-${partyId}`).checked;
    const isHealer = document.getElementById(`memberHealer-${partyId}`).checked;

    if (!nickname) {
        alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const { error } = await supabase
        .from('abyss_members')
        .insert({
            party_id: partyId,
            nickname,
            is_tanker: isTanker,
            is_healer: isHealer
        });

    if (error) {
        alert('ì°¸ê°€ ì‹¤íŒ¨: ' + error.message);
        return;
    }

    loadParties();
}

// ë©¤ë²„ ì‚­ì œ
async function deleteMember(memberId) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('abyss_members')
        .delete()
        .eq('id', memberId);

    if (error) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
        return;
    }

    loadParties();
}

// íŒŒí‹° ì‚­ì œ
async function deleteParty(partyId) {
    if (!confirm('íŒŒí‹° ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('abyss_parties')
        .delete()
        .eq('id', partyId);

    if (error) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
        return;
    }

    loadParties();
}

// íŒŒí‹° ì •ë³´ ë³µì‚¬ (ì¹´ì¹´ì˜¤í†¡ ê³µìœ ìš©)
async function copyPartyInfo(partyId) {
    const party = currentParties.find(p => p.id === partyId);
    if (!party) {
        alert('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const scheduleDate = party.schedule ? new Date(party.schedule) : null;
    const scheduleDisplay = scheduleDate ? formatSchedule(scheduleDate) : '-';

    // ë©¤ë²„ ëª©ë¡ í…ìŠ¤íŠ¸ ìƒì„±
    const memberList = party.abyss_members.map(member => {
        let line = `- ${member.nickname}`;
        const roles = [];
        if (member.is_tanker) roles.push('íƒ±ì»¤');
        if (member.is_healer) roles.push('íëŸ¬');
        if (roles.length > 0) line += ` [${roles.join(', ')}]`;
        return line;
    }).join('\n');

    const text = `[ë¶€ì—‰ê³µí™”êµ­] ì–´ë¹„ìŠ¤ íŒŒí‹° ëª¨ì§‘

ì¼ì •: ${scheduleDisplay}
ë‚œì´ë„: ${party.difficulty || 'ë§¤ìš° ì–´ë ¤ì›€'}
í˜„ì¬ ì¸ì›: ${party.abyss_members.length}/4

ì°¸ê°€ì:
${memberList}

ì°¸ê°€í•˜ê¸°: https://jjinbbang2.github.io/owl/abyss.html`;

    try {
        await navigator.clipboard.writeText(text);
        alert('íŒŒí‹° ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
    } catch (err) {
        // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²•
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('íŒŒí‹° ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
    }
}

// ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
function updateTimeRemaining() {
    document.querySelectorAll('.party-card').forEach(card => {
        const schedule = card.dataset.schedule;
        if (schedule) {
            const timeRemainingEl = card.querySelector('.time-remaining');
            if (timeRemainingEl) {
                timeRemainingEl.innerHTML = getTimeRemaining(new Date(schedule));
            }
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', async function() {
    await deleteExpiredParties(); // ë§Œë£Œëœ íŒŒí‹° ë¨¼ì € ì‚­ì œ
    loadParties();
    initSchedulePicker();
    // 1ë¶„ë§ˆë‹¤ ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸ ë° ë§Œë£Œ íŒŒí‹° ì‚­ì œ
    setInterval(async () => {
        await deleteExpiredParties();
        updateTimeRemaining();
    }, 60000);
});
</script>
</body>
</html>
