<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë ˆì´ë“œ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­</title>

    <meta name="description" content="ë¶€ì—‰ê³µí™”êµ­ ë ˆì´ë“œ ë³´ìŠ¤ íŒŒí‹° ëª¨ì§‘ ê²Œì‹œíŒì…ë‹ˆë‹¤.">
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <meta property="og:title" content="ë ˆì´ë“œ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­">
    <meta property="og:image" content="https://jjinbbang2.github.io/owl/og-image.png">
    <meta name="theme-color" content="#4a3728">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="./styles.css?v=20251226a">
    <!-- ì¹´ì¹´ì˜¤ SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"
            integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4"
            crossorigin="anonymous"></script>
    <style>
        /* ë ˆì´ë“œ ì „ìš©: ë‚œì´ë„ ìƒ‰ìƒ (ì˜¤ë Œì§€) */
        .party-difficulty {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
        }
    </style>
</head>
<body>
<nav class="nav">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">ğŸ¦‰</a>
        <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
        <ul class="nav-menu" id="navMenu">
            <li><a href="index.html">ë­í‚¹</a></li>
            <li><a href="members.html">ëª…ë‹¨</a></li>
            <li><a href="stats.html">í†µê³„</a></li>
            <li><a href="guide.html">ì´ìš©ì•ˆë‚´</a></li>
            <li><a href="abyss.html">ì–´ë¹„ìŠ¤</a></li>
            <li><a href="abyss-help.html">í’ˆì•—ì´</a></li>
            <li><a href="raid.html" class="active">ë ˆì´ë“œ</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <header class="header">
        <div class="header-emblem">âš”ï¸</div>
        <h1 class="header-title">ë ˆì´ë“œ íŒŒí‹°</h1>
        <p class="header-subtitle">ë ˆì´ë“œ ë³´ìŠ¤ íŒŒí‹° ëª¨ì§‘</p>
    </header>

    <section>
        <button class="btn-add-party" onclick="PartyCommon.toggleNewPartyForm()">+ ìƒˆ íŒŒí‹° ë§Œë“¤ê¸°</button>

        <div id="newPartyForm" class="add-form hidden">
            <h3 class="form-title">ìƒˆ ë ˆì´ë“œ íŒŒí‹° ìƒì„±</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>ìš”ì¼Â·ì‹œê°„</label>
                    <input type="text" id="newSchedule" class="schedule-input" placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" readonly>
                    <label class="checkbox-label quick-recruit-label">
                        <input type="checkbox" id="newQuickRecruit" onchange="toggleQuickRecruit()">
                        <span>ë¹ ë¥¸ëª¨ì§‘</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>ë ˆì´ë“œ</label>
                    <select id="newRaidType" onchange="updateDifficultyOptions()">
                        <option value="ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨">ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨ (8ì¸)</option>
                        <option value="í™”ì´íŠ¸ ì„œíë²„ìŠ¤">í™”ì´íŠ¸ ì„œíë²„ìŠ¤ (4ì¸)</option>
                        <option value="íƒ€ë°”ë¥´íƒ€ìŠ¤" selected>íƒ€ë°”ë¥´íƒ€ìŠ¤ (8ì¸)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ë‚œì´ë„</label>
                    <select id="newDifficulty">
                        <option value="ì…ë¬¸">ì…ë¬¸</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                        <option value="ë§¤ìš° ì–´ë ¤ì›€" selected>ë§¤ìš° ì–´ë ¤ì›€</option>
                    </select>
                </div>
            </div>
            <h4 style="color: #888; margin: 15px 0 10px; font-size: 0.9rem;">ì²« ë²ˆì§¸ ì°¸ê°€ì (ë³¸ì¸)</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>ë‹‰ë„¤ì„</label>
                    <input type="text" id="newNickname" placeholder="ìºë¦­í„° ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event, 'newPower')" onblur="fetchCombatPower('newNickname', 'newPower', 'newClass')">
                </div>
                <div class="form-group" style="max-width: 120px;">
                    <label>ì „íˆ¬ë ¥</label>
                    <input type="number" id="newPower" placeholder="ìë™ì…ë ¥" readonly>
                </div>
                <div class="form-group" style="max-width: 100px;">
                    <label>í´ë˜ìŠ¤</label>
                    <input type="text" id="newClass" placeholder="ìë™ì…ë ¥" readonly>
                </div>
            </div>
            <button class="btn-submit" onclick="createParty()">íŒŒí‹° ìƒì„±</button>
        </div>

        <div id="partyList">
            <div class="empty-state">
                <p>íŒŒí‹° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script src="./js/supabase-config.js?v=20251226a"></script>
<script src="./js/combat-power.js?v=20260106c"></script>
<script src="./js/party-share.js?v=20260106c"></script>
<script src="./js/party-common.js?v=20251226a"></script>
<script>
// ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
PartyShare.initKakaoSDK('8e0f458671cc8e81c30125532b95a245');

// í˜„ì¬ íŒŒí‹° ëª©ë¡
let currentParties = [];

// ë ˆì´ë“œë³„ ì •ì›
function getMaxMembers(raidType) {
    return raidType === 'í™”ì´íŠ¸ ì„œíë²„ìŠ¤' ? 4 : 8;
}

// íŒŒí‹° ëª©ë¡ ë¡œë“œ
async function loadParties() {
    const { data: parties, error } = await supabase
        .from('raid_parties')
        .select(`*, raid_members (*)`)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error loading parties:', error);
        document.getElementById('partyList').innerHTML = PartyCommon.renderErrorState(error.message);
        return;
    }

    currentParties = parties || [];
    renderParties(parties);
}

// íŒŒí‹° ë Œë”ë§
function renderParties(parties) {
    const container = document.getElementById('partyList');

    if (!parties || parties.length === 0) {
        container.innerHTML = PartyCommon.renderEmptyState();
        return;
    }

    const sortedParties = PartyCommon.sortParties(parties);

    container.innerHTML = sortedParties.map(party => {
        const raidType = party.raid_type || 'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨';
        const maxMembers = getMaxMembers(raidType);
        const currentMembers = party.raid_members.length;
        const scheduleDate = party.schedule ? new Date(party.schedule) : null;
        const isQuickRecruit = party.is_quick_recruit;
        const scheduleDisplay = isQuickRecruit ? '<span class="quick-recruit-badge">ë¹ ë¥¸ëª¨ì§‘</span>' : (scheduleDate ? PartyCommon.formatSchedule(scheduleDate) : '-');
        const timeRemaining = isQuickRecruit ? '' : (scheduleDate ? PartyCommon.getTimeRemaining(scheduleDate) : '');

        return `
        <div class="party-card" id="party-${party.id}" data-schedule="${party.schedule || ''}" data-quick-recruit="${isQuickRecruit || false}">
            <div class="party-header">
                <div class="party-header-info">
                    <span class="party-schedule">${scheduleDisplay}</span>
                    <span class="time-remaining">${timeRemaining}</span>
                </div>
                <div class="party-header-info">
                    <span class="party-raid-type">${raidType}</span>
                    <span class="party-count">${currentMembers}/${maxMembers}</span>
                    <span class="party-difficulty">${party.difficulty || 'ì–´ë ¤ì›€'}</span>
                </div>
            </div>
            <div class="members-list">
                ${party.raid_members.map(member => `
                    <div class="member-row">
                        <span class="member-nickname">${member.nickname}</span>
                        <span class="member-power">${getDisplayPower(member.nickname, member.combat_power)}</span>
                        <span class="member-class">${member.class_name || '-'}</span>
                        <button class="btn-delete" onclick="deleteMember('${member.id}')">ì‚­ì œ</button>
                    </div>
                `).join('')}
            </div>
            <div class="party-actions">
                ${currentMembers < maxMembers
                    ? `<button class="btn-add-member" onclick="PartyCommon.toggleAddMemberForm('${party.id}')">+ ì°¸ê°€í•˜ê¸°</button>`
                    : '<span style="color: #4ade80; font-size: 0.85rem;">íŒŒí‹° ëª¨ì§‘ ì™„ë£Œ!</span>'}
                <div class="share-container">
                    <button class="btn-share" onclick="PartyShare.toggleShareDropdown('${party.id}')">ê³µìœ </button>
                    <div id="shareDropdown-${party.id}" class="share-dropdown hidden">
                        <div class="share-option kakao" onclick="shareToKakaoWrapper('${party.id}')">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</div>
                        <div class="share-option clipboard" onclick="copyPartyInfoWrapper('${party.id}')">ğŸ“‹ í´ë¦½ë³´ë“œ</div>
                    </div>
                </div>
                <button class="btn-delete-party" onclick="deleteParty('${party.id}')">íŒŒí‹° ì‚­ì œ</button>
            </div>
            <div id="addMemberForm-${party.id}" class="add-member-form hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>ë‹‰ë„¤ì„</label>
                        <input type="text" id="memberNickname-${party.id}" placeholder="ìºë¦­í„° ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event, 'memberPower-${party.id}')" onblur="fetchCombatPower('memberNickname-${party.id}', 'memberPower-${party.id}', 'memberClass-${party.id}')">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>ì „íˆ¬ë ¥</label>
                        <input type="number" id="memberPower-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                    <div class="form-group" style="max-width: 100px;">
                        <label>í´ë˜ìŠ¤</label>
                        <input type="text" id="memberClass-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                </div>
                <button class="btn-submit" onclick="addMember('${party.id}')" style="padding: 8px 20px; font-size: 0.9rem;">ì°¸ê°€</button>
            </div>
        </div>
    `;
    }).join('');
}

// ë¹ ë¥¸ëª¨ì§‘ í† ê¸€
function toggleQuickRecruit() {
    const checkbox = document.getElementById('newQuickRecruit');
    const scheduleInput = document.getElementById('newSchedule');

    if (checkbox.checked) {
        scheduleInput.disabled = true;
        scheduleInput.value = 'ë¹ ë¥¸ëª¨ì§‘ (í˜„ì¬ì‹œê°„)';
        scheduleInput.classList.add('disabled');
    } else {
        scheduleInput.disabled = false;
        scheduleInput.value = '';
        scheduleInput.classList.remove('disabled');
        PartyCommon.clearScheduleDate();
    }
}

// ë ˆì´ë“œ íƒ€ì…ì— ë”°ë¼ ë‚œì´ë„ ì˜µì…˜ ë³€ê²½
function updateDifficultyOptions() {
    const raidType = document.getElementById('newRaidType').value;
    const difficultySelect = document.getElementById('newDifficulty');

    const options = {
        'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨': '<option value="ì…ë¬¸">ì…ë¬¸</option><option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option><option value="ë§¤ìš° ì–´ë ¤ì›€" selected>ë§¤ìš° ì–´ë ¤ì›€</option>',
        'í™”ì´íŠ¸ ì„œíë²„ìŠ¤': '<option value="ì–´ë ¤ì›€" selected>ì–´ë ¤ì›€</option>',
        'íƒ€ë°”ë¥´íƒ€ìŠ¤': '<option value="ì…ë¬¸">ì…ë¬¸</option><option value="ì–´ë ¤ì›€" selected>ì–´ë ¤ì›€</option>'
    };

    difficultySelect.innerHTML = options[raidType] || options['ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨'];
}

// íŒŒí‹° ìƒì„±
async function createParty() {
    const isQuickRecruit = document.getElementById('newQuickRecruit').checked;
    const raidType = document.getElementById('newRaidType').value;
    const difficulty = document.getElementById('newDifficulty').value;
    const nickname = document.getElementById('newNickname').value.trim();
    const combatPower = getActualPowerValue('newPower');
    const combatPowerDisplay = document.getElementById('newPower').value;
    const className = document.getElementById('newClass').value.trim();

    if (!isQuickRecruit && !PartyCommon.getSelectedScheduleDate()) {
        alert('ìš”ì¼Â·ì‹œê°„ì„ ì„ íƒí•˜ê±°ë‚˜ ë¹ ë¥¸ëª¨ì§‘ì„ ì²´í¬í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¹„ê³µê°œë„ ìœ íš¨í•œ ê°’ìœ¼ë¡œ ì²˜ë¦¬
    if (!nickname || (!combatPower && combatPowerDisplay !== 'ë¹„ê³µê°œ') || !className) {
        alert('ë‹‰ë„¤ì„, ì „íˆ¬ë ¥, í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const schedule = isQuickRecruit ? new Date().toISOString() : PartyCommon.getSelectedScheduleDate().toISOString();

    const { data: party, error: partyError } = await supabase
        .from('raid_parties')
        .insert({ schedule, difficulty, raid_type: raidType, is_quick_recruit: isQuickRecruit })
        .select()
        .single();

    if (partyError) {
        alert('íŒŒí‹° ìƒì„± ì‹¤íŒ¨: ' + partyError.message);
        return;
    }

    const { error: memberError } = await supabase
        .from('raid_members')
        .insert({
            party_id: party.id,
            nickname,
            combat_power: combatPower || null,
            class_name: className || null
        });

    if (memberError) {
        alert('ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + memberError.message);
        return;
    }

    // í¼ ì´ˆê¸°í™”
    PartyCommon.clearScheduleDate();
    document.getElementById('newQuickRecruit').checked = false;
    document.getElementById('newSchedule').disabled = false;
    document.getElementById('newSchedule').classList.remove('disabled');
    document.getElementById('newRaidType').value = 'íƒ€ë°”ë¥´íƒ€ìŠ¤';
    updateDifficultyOptions();
    document.getElementById('newNickname').value = '';
    document.getElementById('newPower').value = '';
    document.getElementById('newClass').value = '';
    document.getElementById('newPartyForm').classList.add('hidden');

    loadParties();
}

// ë©¤ë²„ ì¶”ê°€
async function addMember(partyId) {
    const nickname = document.getElementById(`memberNickname-${partyId}`).value.trim();
    const combatPower = getActualPowerValue(`memberPower-${partyId}`);
    const combatPowerDisplay = document.getElementById(`memberPower-${partyId}`).value;
    const className = document.getElementById(`memberClass-${partyId}`).value.trim();

    // ë¹„ê³µê°œë„ ìœ íš¨í•œ ê°’ìœ¼ë¡œ ì²˜ë¦¬
    if (!nickname || (!combatPower && combatPowerDisplay !== 'ë¹„ê³µê°œ') || !className) {
        alert('ë‹‰ë„¤ì„, ì „íˆ¬ë ¥, í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const party = currentParties.find(p => p.id === partyId);
    if (party && party.raid_members.some(m => m.nickname === nickname)) {
        alert('ì´ë¯¸ ì°¸ê°€í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
        return;
    }

    const { error } = await supabase
        .from('raid_members')
        .insert({
            party_id: partyId,
            nickname,
            combat_power: combatPower || null,
            class_name: className || null
        });

    if (error) {
        alert('ì°¸ê°€ ì‹¤íŒ¨: ' + error.message);
        return;
    }

    loadParties();
}

// ë©¤ë²„ ì‚­ì œ
async function deleteMember(memberId) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('raid_members')
        .delete()
        .eq('id', memberId);

    if (error) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
        return;
    }

    loadParties();
}

// íŒŒí‹° ì‚­ì œ
async function deleteParty(partyId) {
    if (!confirm('íŒŒí‹° ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('raid_parties')
        .delete()
        .eq('id', partyId);

    if (error) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
        return;
    }

    loadParties();
}

// ê³µìœ  ë˜í¼
function copyPartyInfoWrapper(partyId) {
    const party = currentParties.find(p => p.id === partyId);
    if (!party) {
        alert('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const { text } = PartyShare.generatePartyText(party, 'raid');
    PartyShare.copyToClipboard(text);
}

function shareToKakaoWrapper(partyId) {
    const party = currentParties.find(p => p.id === partyId);
    if (!party) {
        alert('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    PartyShare.shareToKakao(party, 'raid');
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
    await loadRankingData();  // ì „íˆ¬ë ¥ ë¹„ê³µê°œ ì„¤ì • í™•ì¸ìš©
    await PartyCommon.deleteExpiredParties('raid_parties');
    loadParties();
    PartyCommon.initSchedulePicker('#newSchedule', 23);

    setInterval(async () => {
        await PartyCommon.deleteExpiredParties('raid_parties');
        PartyCommon.updateTimeRemaining();
    }, 60000);
});
</script>
</body>
</html>
