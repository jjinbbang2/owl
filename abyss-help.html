<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í’ˆì•—ì´ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­</title>

    <meta name="description" content="ë¶€ì—‰ê³µí™”êµ­ ì–´ë¹„ìŠ¤ í’ˆì•—ì´ íŒŒí‹° ëª¨ì§‘ ê²Œì‹œíŒì…ë‹ˆë‹¤.">
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <meta property="og:title" content="í’ˆì•—ì´ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­">
    <meta property="og:image" content="https://jjinbbang2.github.io/owl/og-image.png">
    <meta name="theme-color" content="#4a3728">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="./styles.css?v=2025120802">
    <!-- ì¹´ì¹´ì˜¤ SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"
            integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4"
            crossorigin="anonymous"></script>
    <style>
        .party-card {
            background    : rgba(26, 27, 38, 0.95);
            border-radius : 12px;
            padding       : 20px;
            margin-bottom : 20px;
            box-shadow    : 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .party-header {
            display         : flex;
            justify-content : space-between;
            align-items     : flex-start;
            gap             : 10px;
            margin-bottom   : 15px;
            padding-bottom  : 15px;
            border-bottom   : 1px solid rgba(212, 175, 55, 0.2);
            flex-wrap       : wrap;
        }
        .party-header > div {
            display     : flex;
            align-items : center;
            gap         : 8px;
            flex-wrap   : wrap;
        }
        .party-schedule {
            font-size   : 1.1rem;
            font-weight : 700;
            color       : var(--primary-gold);
        }
        .time-remaining {
            font-size  : 0.85rem;
            color      : #888;
            display    : block;
            margin-top : 4px;
        }
        .party-difficulty {
            background    : rgba(244, 114, 182, 0.2);
            color         : #f472b6;
            padding       : 4px 12px;
            border-radius : 20px;
            font-size     : 0.8rem;
            white-space   : nowrap;
        }
        .party-count {
            background    : rgba(122, 162, 247, 0.2);
            color         : var(--accent-blue);
            padding       : 4px 12px;
            border-radius : 20px;
            font-size     : 0.8rem;
            white-space   : nowrap;
        }
        @media (max-width : 480px) {
            .party-header {
                flex-direction : column;
                align-items    : stretch;
                gap            : 8px;
            }
            .party-header > div {
                justify-content : flex-start;
            }
            .party-schedule {
                font-size : 1rem;
            }
        }
        .members-list {
            display        : flex;
            flex-direction : column;
            gap            : 10px;
        }
        .member-row {
            display               : grid;
            grid-template-columns : 1fr auto 1fr auto auto;
            align-items           : center;
            gap                   : 12px;
            padding               : 12px;
            background            : rgba(0, 0, 0, 0.2);
            border-radius         : 8px;
        }
        @media (max-width : 600px) {
            .member-row {
                grid-template-columns : 1fr 1fr;
                gap                   : 8px;
                padding               : 10px;
            }
            .member-row > div {
                display        : flex;
                flex-direction : column;
                gap            : 2px;
            }
            .member-row .btn-delete {
                grid-column  : span 2;
                justify-self : end;
                margin-top   : 4px;
            }
            .member-nickname {
                font-size : 0.9rem;
            }
            .member-power {
                font-size : 0.85rem;
            }
        }
        .member-label {
            font-size : 0.7rem;
            color     : #888;
            display   : block;
        }
        .member-nickname {
            font-weight : 500;
            word-break  : break-all;
        }
        .member-power {
            color       : var(--accent-blue);
            font-weight : 600;
            text-align  : right;
        }
        .main-char {
            color : var(--primary-gold);
        }
        .sub-char {
            color : #4ade80;
        }
        .btn-delete {
            background    : rgba(248, 113, 113, 0.2);
            color         : #f87171;
            border        : none;
            padding       : 6px 10px;
            border-radius : 6px;
            cursor        : pointer;
            font-size     : 0.8rem;
        }
        .btn-delete:hover {
            background : rgba(248, 113, 113, 0.4);
        }
        .add-form {
            background    : rgba(26, 27, 38, 0.95);
            border-radius : 12px;
            padding       : 25px;
            margin-bottom : 30px;
            box-shadow    : 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .form-title {
            color         : var(--primary-gold);
            margin-bottom : 20px;
            font-size     : 1.1rem;
        }
        .form-row {
            display       : flex;
            gap           : 15px;
            margin-bottom : 15px;
            flex-wrap     : wrap;
        }
        .form-group {
            flex      : 1;
            min-width : 120px;
        }
        .form-group label {
            display       : block;
            margin-bottom : 5px;
            color         : #888;
            font-size     : 0.85rem;
        }
        .form-group input, .form-group select {
            width              : 100%;
            height             : 42px;
            padding            : 10px;
            border             : 1px solid rgba(255, 255, 255, 0.1);
            border-radius      : 8px;
            background         : rgba(0, 0, 0, 0.3);
            color              : var(--text-light);
            font-size          : 16px;
            box-sizing         : border-box;
            -webkit-appearance : none;
            appearance         : none;
        }
        .form-group input:focus, .form-group select:focus {
            outline      : none;
            border-color : var(--primary-gold);
        }
        .btn-submit {
            background    : linear-gradient(145deg, var(--primary-gold), #b8960b);
            color         : #000;
            border        : none;
            padding       : 12px 30px;
            border-radius : 8px;
            font-weight   : 600;
            cursor        : pointer;
            font-size     : 1rem;
            transition    : transform 0.2s;
        }
        .btn-submit:hover {
            transform : translateY(-2px);
        }
        .btn-add-party {
            background    : rgba(122, 162, 247, 0.2);
            color         : var(--accent-blue);
            border        : 1px dashed var(--accent-blue);
            padding       : 15px;
            border-radius : 12px;
            width         : 100%;
            cursor        : pointer;
            font-size     : 1rem;
            margin-bottom : 20px;
            transition    : all 0.2s;
        }
        .btn-add-party:hover {
            background : rgba(122, 162, 247, 0.3);
        }
        .empty-state {
            text-align : center;
            padding    : 60px 20px;
            color      : #888;
        }
        .hidden {
            display : none;
        }
        /* Flatpickr ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .flatpickr-calendar {
            background : rgba(26, 27, 38, 0.98) !important;
            border     : 1px solid rgba(212, 175, 55, 0.3) !important;
            box-shadow : 0 8px 30px rgba(0, 0, 0, 0.5) !important;
        }
        .flatpickr-day.selected {
            background   : var(--primary-gold) !important;
            border-color : var(--primary-gold) !important;
            color        : #000 !important;
        }
        .flatpickr-day:hover {
            background : rgba(212, 175, 55, 0.3) !important;
        }
        .flatpickr-time input {
            background : rgba(0, 0, 0, 0.3) !important;
            color      : var(--text-light) !important;
        }
        .flatpickr-time .flatpickr-am-pm {
            background : rgba(0, 0, 0, 0.3) !important;
            color      : var(--text-light) !important;
        }
        .schedule-input {
            cursor : pointer !important;
        }
        .party-actions {
            margin-top  : 15px;
            padding-top : 15px;
            border-top  : 1px solid rgba(255, 255, 255, 0.05);
        }
        .btn-add-member {
            background    : rgba(74, 222, 128, 0.2);
            color         : #4ade80;
            border        : none;
            padding       : 8px 16px;
            border-radius : 6px;
            cursor        : pointer;
            font-size     : 0.85rem;
        }
        .btn-add-member:hover {
            background : rgba(74, 222, 128, 0.3);
        }
        .btn-delete-party {
            background    : rgba(248, 113, 113, 0.2);
            color         : #f87171;
            border        : none;
            padding       : 8px 16px;
            border-radius : 6px;
            cursor        : pointer;
            font-size     : 0.85rem;
            margin-left   : 10px;
        }
        .btn-share {
            background    : rgba(250, 225, 0, 0.2);
            color         : #fae100;
            border        : none;
            padding       : 8px 16px;
            border-radius : 6px;
            cursor        : pointer;
            font-size     : 0.85rem;
            margin-left   : 10px;
        }
        .btn-share:hover {
            background : rgba(250, 225, 0, 0.3);
        }
        .btn-share::after {
            content     : 'â–¼';
            font-size   : 0.6rem;
            margin-left : 4px;
        }
        /* ê³µìœ  ë“œë¡­ë‹¤ìš´ */
        .share-container {
            position : relative;
            display  : inline-block;
        }
        .share-dropdown {
            position      : absolute;
            top           : 100%;
            right         : 0;
            margin-top    : 5px;
            background    : rgba(26, 27, 38, 0.98);
            border        : 1px solid rgba(250, 225, 0, 0.3);
            border-radius : 8px;
            box-shadow    : 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width     : 150px;
            z-index       : 1000;
            overflow      : hidden;
        }
        .share-dropdown.hidden {
            display : none;
        }
        .share-option {
            padding       : 12px 16px;
            cursor        : pointer;
            transition    : background 0.2s;
            display       : flex;
            align-items   : center;
            gap           : 8px;
            color         : var(--text-light);
            font-size     : 0.85rem;
            border-bottom : 1px solid rgba(255, 255, 255, 0.05);
        }
        .share-option:last-child {
            border-bottom : none;
        }
        .share-option:hover {
            background : rgba(250, 225, 0, 0.1);
        }
        .share-option.kakao {
            color : #fae100;
        }
        .share-option.clipboard {
            color : var(--accent-blue);
        }
        .add-member-form {
            margin-top    : 15px;
            padding       : 15px;
            background    : rgba(0, 0, 0, 0.2);
            border-radius : 8px;
        }
        .form-section-title {
            color          : #888;
            font-size      : 0.85rem;
            margin         : 15px 0 10px;
            padding-bottom : 5px;
            border-bottom  : 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
<nav class="nav">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">ğŸ¦‰</a>
        <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
        <ul class="nav-menu" id="navMenu">
            <li><a href="index.html">ë­í‚¹</a></li>
            <li><a href="guide.html">ì´ìš©ì•ˆë‚´</a></li>
            <li><a href="abyss.html">ì–´ë¹„ìŠ¤</a></li>
            <li><a href="abyss-help.html" class="active">í’ˆì•—ì´</a></li>
            <li><a href="raid.html">ë ˆì´ë“œ</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <header class="header">
        <div class="header-emblem">ğŸ¤</div>
        <h1 class="header-title">í’ˆì•—ì´ íŒŒí‹°</h1>
        <p class="header-subtitle">ë³¸ìºë¡œ ë¶€ìº ë°€ì–´ì£¼ê¸°</p>
    </header>

    <section>
        <button class="btn-add-party" onclick="toggleNewPartyForm()">+ ìƒˆ íŒŒí‹° ë§Œë“¤ê¸°</button>

        <div id="newPartyForm" class="add-form hidden">
            <h3 class="form-title">ìƒˆ í’ˆì•—ì´ íŒŒí‹° ìƒì„±</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>ìš”ì¼Â·ì‹œê°„</label>
                    <input type="text" id="newSchedule" class="schedule-input" placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" readonly>
                </div>
                <div class="form-group">
                    <label>ë‚œì´ë„</label>
                    <select id="newDifficulty">
                        <option value="ì…ë¬¸">ì…ë¬¸</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                        <option value="ë§¤ìš° ì–´ë ¤ì›€" selected>ë§¤ìš° ì–´ë ¤ì›€</option>
                        <option value="ì§€ì˜¥ 1">ì§€ì˜¥ 1</option>
                        <option value="ì§€ì˜¥ 2">ì§€ì˜¥ 2</option>
                        <option value="ì§€ì˜¥ 3">ì§€ì˜¥ 3</option>
                        <option value="ì§€ì˜¥ 4">ì§€ì˜¥ 4</option>
                        <option value="ì§€ì˜¥ 5">ì§€ì˜¥ 5</option>
                        <option value="ì§€ì˜¥ 6">ì§€ì˜¥ 6</option>
                        <option value="ì§€ì˜¥ 7">ì§€ì˜¥ 7</option>
                        <option value="ì§€ì˜¥ 8">ì§€ì˜¥ 8</option>
                        <option value="ì§€ì˜¥ 9">ì§€ì˜¥ 9</option>
                        <option value="ì§€ì˜¥ 10">ì§€ì˜¥ 10</option>
                    </select>
                </div>
            </div>
            <div class="form-section-title">ë³¸ìº ì •ë³´</div>
            <div class="form-row">
                <div class="form-group">
                    <label>ë³¸ìº ë‹‰ë„¤ì„</label>
                    <input type="text" id="newMainNickname" placeholder="ë³¸ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('newMainNickname', 'newMainPower')">
                </div>
                <div class="form-group" style="max-width: 120px;">
                    <label>ë³¸ìº íˆ¬ë ¥</label>
                    <input type="number" id="newMainPower" placeholder="ìë™ì…ë ¥" readonly>
                </div>
            </div>
            <div class="form-section-title">ë¶€ìº ì •ë³´</div>
            <div class="form-row">
                <div class="form-group">
                    <label>ë¶€ìº ë‹‰ë„¤ì„</label>
                    <input type="text" id="newSubNickname" placeholder="ë¶€ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('newSubNickname', 'newSubPower')">
                </div>
                <div class="form-group" style="max-width: 120px;">
                    <label>ë¶€ìº íˆ¬ë ¥</label>
                    <input type="number" id="newSubPower" placeholder="ìë™ì…ë ¥" readonly>
                </div>
            </div>
            <button class="btn-submit" onclick="createParty()">íŒŒí‹° ìƒì„±</button>
        </div>

        <div id="partyList">
            <div class="empty-state">
                <p>íŒŒí‹° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script src="./js/supabase-config.js"></script>
<script src="./js/combat-power.js"></script>
<script src="./js/party-share.js"></script>
<script>
// ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” (ì•±í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥)
PartyShare.initKakaoSDK('8e0f458671cc8e81c30125532b95a245');
</script>
<script>
    // ìš”ì¼ ë°°ì—´
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜: "2025-12-08 21:30(ì›”)" í˜•ì‹
    function formatSchedule(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        const dayName = dayNames[date.getDay()];
        return `${year}-${month}-${day} ${hour}:${minute}(${dayName})`;
    }

    // ë§Œë£Œëœ íŒŒí‹° ì‚­ì œ (ëª¨ì§‘ ì‹œê°„ + 3ì‹œê°„ ì§€ë‚œ íŒŒí‹°)
    async function deleteExpiredParties() {
        const threeHoursAgo = new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString();

        const {error} = await supabase
            .from('help_parties')
            .delete()
            .lt('schedule', threeHoursAgo);

        if (error) {
            console.error('ë§Œë£Œ íŒŒí‹° ì‚­ì œ ì‹¤íŒ¨:', error);
        }
    }

    // ë‚¨ì€ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
    function getTimeRemaining(targetDate) {
        const now = new Date();
        const diff = targetDate - now;

        if (diff <= 0) {
            return '<span style="color: #f87171;">ì¢…ë£Œë¨</span>';
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        if (days > 0) {
            return `<span style="color: #4ade80;">${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ</span>`;
        } else if (hours > 0) {
            return `<span style="color: #fbbf24;">${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ</span>`;
        } else {
            return `<span style="color: #f87171;">${minutes}ë¶„ ë‚¨ìŒ</span>`;
        }
    }

    // Flatpickr ì´ˆê¸°í™”
    let schedulePicker;
    let selectedScheduleDate = null; // datetime ì €ì¥ìš©
    let currentParties = []; // íŒŒí‹° ëª©ë¡ ì €ì¥ìš©

    function initSchedulePicker() {
        schedulePicker = flatpickr("#newSchedule", {
            locale         : "ko",
            enableTime     : true,
            noCalendar     : false,
            dateFormat     : "Y-m-d H:i",
            time_24hr      : true,
            minuteIncrement: 30,
            defaultHour    : 21,
            minDate        : "today",
            onChange       : function (selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    selectedScheduleDate = selectedDates[0]; // datetime ì €ì¥
                    instance.element.value = formatSchedule(selectedDates[0]);
                }
            }
        });
    }

    async function loadParties() {
        const {data: parties, error} = await supabase
            .from('help_parties')
            .select(`
            *,
            help_members (*)
        `)
            .order('created_at', {ascending: false});

        if (error) {
            console.error('Error loading parties:', error);
            document.getElementById('partyList').innerHTML = `
            <div class="empty-state">
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 0.85rem; margin-top: 10px;">${error.message}</p>
            </div>
        `;
            return;
        }

        currentParties = parties || [];
        renderParties(parties);
    }

    function renderParties(parties) {
        const container = document.getElementById('partyList');

        if (!parties || parties.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <p>ì•„ì§ ë“±ë¡ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 0.85rem; margin-top: 10px;">ìƒˆ íŒŒí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            </div>
        `;
            return;
        }

        container.innerHTML = parties.map(party => {
            // datetimeì„ í¬ë§·íŒ…í•´ì„œ í‘œì‹œ
            const scheduleDate = party.schedule ? new Date(party.schedule) : null;
            const scheduleDisplay = scheduleDate ? formatSchedule(scheduleDate) : '-';
            const timeRemaining = scheduleDate ? getTimeRemaining(scheduleDate) : '';
            return `
        <div class="party-card" id="party-${party.id}" data-schedule="${party.schedule || ''}">
            <div class="party-header">
                <div>
                    <span class="party-schedule">${scheduleDisplay}</span>
                    <span class="time-remaining">${timeRemaining}</span>
                </div>
                <div>
                    <span class="party-count">${party.help_members.length}/4</span>
                    <span class="party-difficulty">${party.difficulty || 'ì§€ì˜¥ 4'}</span>
                </div>
            </div>
            <div class="members-list">
                ${party.help_members.map(member => `
                    <div class="member-row">
                        <div>
                            <span class="member-label">ë³¸ìº</span>
                            <span class="member-nickname main-char">${member.main_nickname}</span>
                        </div>
                        <div>
                            <span class="member-label">íˆ¬ë ¥</span>
                            <span class="member-power">${member.main_power ? member.main_power.toLocaleString() : '-'}</span>
                        </div>
                        <div>
                            <span class="member-label">ë¶€ìº</span>
                            <span class="member-nickname sub-char">${member.sub_nickname || '-'}</span>
                        </div>
                        <div>
                            <span class="member-label">íˆ¬ë ¥</span>
                            <span class="member-power">${member.sub_power ? member.sub_power.toLocaleString() : '-'}</span>
                        </div>
                        <button class="btn-delete" onclick="deleteMember('${member.id}')">ì‚­ì œ</button>
                    </div>
                `).join('')}
            </div>
            <div class="party-actions">
                ${party.help_members.length < 4
                ? `<button class="btn-add-member" onclick="toggleAddMemberForm('${party.id}')">+ ì°¸ê°€í•˜ê¸°</button>`
                : '<span style="color: #4ade80; font-size: 0.85rem;">íŒŒí‹° ëª¨ì§‘ ì™„ë£Œ!</span>'}
                <div class="share-container">
                    <button class="btn-share" onclick="PartyShare.toggleShareDropdown('${party.id}')">ê³µìœ </button>
                    <div id="shareDropdown-${party.id}" class="share-dropdown hidden">
                        <div class="share-option kakao" onclick="shareToKakaoWrapper('${party.id}')">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</div>
                        <div class="share-option clipboard" onclick="copyPartyInfoWrapper('${party.id}')">ğŸ“‹ í´ë¦½ë³´ë“œ</div>
                    </div>
                </div>
                <button class="btn-delete-party" onclick="deleteParty('${party.id}')">íŒŒí‹° ì‚­ì œ</button>
            </div>
            <div id="addMemberForm-${party.id}" class="add-member-form hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>ë³¸ìº ë‹‰ë„¤ì„</label>
                        <input type="text" id="mainNickname-${party.id}" placeholder="ë³¸ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('mainNickname-${party.id}', 'mainPower-${party.id}')">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>ë³¸ìº íˆ¬ë ¥</label>
                        <input type="number" id="mainPower-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                    <div class="form-group">
                        <label>ë¶€ìº ë‹‰ë„¤ì„</label>
                        <input type="text" id="subNickname-${party.id}" placeholder="ë¶€ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('subNickname-${party.id}', 'subPower-${party.id}')">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>ë¶€ìº íˆ¬ë ¥</label>
                        <input type="number" id="subPower-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                </div>
                <button class="btn-submit" onclick="addMember('${party.id}')" style="padding: 8px 20px; font-size: 0.9rem;">ì°¸ê°€</button>
            </div>
        </div>
    `;
        }).join('');
    }

    function toggleNewPartyForm() {
        document.getElementById('newPartyForm').classList.toggle('hidden');
    }

    function toggleAddMemberForm(partyId) {
        document.getElementById(`addMemberForm-${partyId}`).classList.toggle('hidden');
    }

    async function createParty() {
        const difficulty = document.getElementById('newDifficulty').value;
        const mainNickname = document.getElementById('newMainNickname').value.trim();
        const mainPower = document.getElementById('newMainPower').value;
        const subNickname = document.getElementById('newSubNickname').value.trim();
        const subPower = document.getElementById('newSubPower').value;

        if (!selectedScheduleDate || !mainNickname) {
            alert('ìš”ì¼Â·ì‹œê°„ê³¼ ë³¸ìº ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // datetimeì„ ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const schedule = selectedScheduleDate.toISOString();

        const {data: party, error: partyError} = await supabase
            .from('help_parties')
            .insert({schedule, difficulty})
            .select()
            .single();

        if (partyError) {
            alert('íŒŒí‹° ìƒì„± ì‹¤íŒ¨: ' + partyError.message);
            return;
        }

        const {error: memberError} = await supabase
            .from('help_members')
            .insert({
                party_id     : party.id,
                main_nickname: mainNickname,
                main_power   : mainPower ? parseInt(mainPower, 10) : null,
                sub_nickname : subNickname || null,
                sub_power    : subPower ? parseInt(subPower, 10) : null
            });

        if (memberError) {
            alert('ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + memberError.message);
            return;
        }

        schedulePicker.clear();
        selectedScheduleDate = null;
        document.getElementById('newMainNickname').value = '';
        document.getElementById('newMainPower').value = '';
        document.getElementById('newSubNickname').value = '';
        document.getElementById('newSubPower').value = '';
        document.getElementById('newPartyForm').classList.add('hidden');

        loadParties();
    }

    async function addMember(partyId) {
        const mainNickname = document.getElementById(`mainNickname-${partyId}`).value.trim();
        const mainPower = document.getElementById(`mainPower-${partyId}`).value;
        const subNickname = document.getElementById(`subNickname-${partyId}`).value.trim();
        const subPower = document.getElementById(`subPower-${partyId}`).value;

        if (!mainNickname) {
            alert('ë³¸ìº ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const {error} = await supabase
            .from('help_members')
            .insert({
                party_id     : partyId,
                main_nickname: mainNickname,
                main_power   : mainPower ? parseInt(mainPower, 10) : null,
                sub_nickname : subNickname || null,
                sub_power    : subPower ? parseInt(subPower, 10) : null
            });

        if (error) {
            alert('ì°¸ê°€ ì‹¤íŒ¨: ' + error.message);
            return;
        }

        loadParties();
    }

    async function deleteMember(memberId) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const {error} = await supabase
            .from('help_members')
            .delete()
            .eq('id', memberId);

        if (error) {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            return;
        }

        loadParties();
    }

    async function deleteParty(partyId) {
        if (!confirm('íŒŒí‹° ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const {error} = await supabase
            .from('help_parties')
            .delete()
            .eq('id', partyId);

        if (error) {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            return;
        }

        loadParties();
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬ ë˜í¼
    function copyPartyInfoWrapper(partyId) {
        const party = currentParties.find(p => p.id === partyId);
        if (!party) {
            alert('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        const { text } = PartyShare.generatePartyText(party, 'help');
        PartyShare.copyToClipboard(text);
    }

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ë˜í¼
    function shareToKakaoWrapper(partyId) {
        const party = currentParties.find(p => p.id === partyId);
        if (!party) {
            alert('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        PartyShare.shareToKakao(party, 'help');
    }

    // ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
    function updateTimeRemaining() {
        document.querySelectorAll('.party-card').forEach(card => {
            const schedule = card.dataset.schedule;
            if (schedule) {
                const timeRemainingEl = card.querySelector('.time-remaining');
                if (timeRemainingEl) {
                    timeRemainingEl.innerHTML = getTimeRemaining(new Date(schedule));
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', async function () {
        await deleteExpiredParties(); // ë§Œë£Œëœ íŒŒí‹° ë¨¼ì € ì‚­ì œ
        loadParties();
        initSchedulePicker();
        // 1ë¶„ë§ˆë‹¤ ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸ ë° ë§Œë£Œ íŒŒí‹° ì‚­ì œ
        setInterval(async () => {
            await deleteExpiredParties();
            updateTimeRemaining();
        }, 60000);
    });
</script>
</body>
</html>
