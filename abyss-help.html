<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í’ˆì•—ì´ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­</title>

    <meta name="description" content="ë¶€ì—‰ê³µí™”êµ­ ì–´ë¹„ìŠ¤ í’ˆì•—ì´ íŒŒí‹° ëª¨ì§‘ ê²Œì‹œíŒì…ë‹ˆë‹¤.">
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <meta property="og:title" content="í’ˆì•—ì´ íŒŒí‹° - ë¶€ì—‰ê³µí™”êµ­">
    <meta property="og:image" content="https://jjinbbang2.github.io/owl/og-image.png">
    <meta name="theme-color" content="#4a3728">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="./styles.css?v=20251218a">
    <!-- ì¹´ì¹´ì˜¤ SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"
            integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4"
            crossorigin="anonymous"></script>
    <style>
        /* í’ˆì•—ì´ ì „ìš©: ë‚œì´ë„ ìƒ‰ìƒ (í•‘í¬) */
        .party-difficulty {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
        }
    </style>
</head>
<body>
<nav class="nav">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">ğŸ¦‰</a>
        <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
        <ul class="nav-menu" id="navMenu">
            <li><a href="index.html">ë­í‚¹</a></li>
            <li><a href="guide.html">ì´ìš©ì•ˆë‚´</a></li>
            <li><a href="abyss.html">ì–´ë¹„ìŠ¤</a></li>
            <li><a href="abyss-help.html" class="active">í’ˆì•—ì´</a></li>
            <li><a href="raid.html">ë ˆì´ë“œ</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <header class="header">
        <div class="header-emblem">ğŸ¤</div>
        <h1 class="header-title">í’ˆì•—ì´ íŒŒí‹°</h1>
        <p class="header-subtitle">ì–´ë¹„ìŠ¤ í’ˆì•—ì´ íŒŒí‹° ëª¨ì§‘</p>
    </header>

    <section>
        <button class="btn-add-party" onclick="PartyCommon.toggleNewPartyForm()">+ ìƒˆ íŒŒí‹° ë§Œë“¤ê¸°</button>

        <div id="newPartyForm" class="add-form hidden">
            <h3 class="form-title">ìƒˆ í’ˆì•—ì´ íŒŒí‹° ìƒì„±</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>ìš”ì¼Â·ì‹œê°„</label>
                    <input type="text" id="newSchedule" class="schedule-input" placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" readonly>
                </div>
                <div class="form-group">
                    <label>ë‚œì´ë„</label>
                    <select id="newDifficulty">
                        <option value="ì…ë¬¸">ì…ë¬¸</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                        <option value="ë§¤ìš° ì–´ë ¤ì›€" selected>ë§¤ìš° ì–´ë ¤ì›€</option>
                        <option value="ì§€ì˜¥ 1">ì§€ì˜¥ 1</option>
                        <option value="ì§€ì˜¥ 2">ì§€ì˜¥ 2</option>
                        <option value="ì§€ì˜¥ 3">ì§€ì˜¥ 3</option>
                        <option value="ì§€ì˜¥ 4">ì§€ì˜¥ 4</option>
                        <option value="ì§€ì˜¥ 5">ì§€ì˜¥ 5</option>
                        <option value="ì§€ì˜¥ 6">ì§€ì˜¥ 6</option>
                        <option value="ì§€ì˜¥ 7">ì§€ì˜¥ 7</option>
                        <option value="ì§€ì˜¥ 8">ì§€ì˜¥ 8</option>
                        <option value="ì§€ì˜¥ 9">ì§€ì˜¥ 9</option>
                        <option value="ì§€ì˜¥ 10">ì§€ì˜¥ 10</option>
                    </select>
                </div>
            </div>
            <h4 class="form-section-title">ë³¸ìº (ë„ì›€ ì£¼ëŠ” ìºë¦­í„°)</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>ë‹‰ë„¤ì„</label>
                    <input type="text" id="newMainNickname" placeholder="ë³¸ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('newMainNickname', 'newMainPower', 'newMainClass')">
                </div>
                <div class="form-group" style="max-width: 120px;">
                    <label>ì „íˆ¬ë ¥</label>
                    <input type="number" id="newMainPower" placeholder="ìë™ì…ë ¥" readonly>
                </div>
                <div class="form-group" style="max-width: 100px;">
                    <label>í´ë˜ìŠ¤</label>
                    <input type="text" id="newMainClass" placeholder="ìë™ì…ë ¥" readonly>
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 10px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="newMainOnly" onchange="toggleSubCharSection('new')">
                    <span>ë³¸ìºë§Œ ì°¸ì—¬ (ë„ì›€ë§Œ ì£¼ê¸°)</span>
                </label>
            </div>
            <div id="subCharSection-new">
                <h4 class="form-section-title">ë¶€ìº (ë„ì›€ ë°›ëŠ” ìºë¦­í„°)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë‹‰ë„¤ì„</label>
                        <input type="text" id="newSubNickname" placeholder="ë¶€ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('newSubNickname', 'newSubPower', 'newSubClass')">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>ì „íˆ¬ë ¥</label>
                        <input type="number" id="newSubPower" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                    <div class="form-group" style="max-width: 100px;">
                        <label>í´ë˜ìŠ¤</label>
                        <input type="text" id="newSubClass" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                </div>
            </div>
            <button class="btn-submit" onclick="createParty()">íŒŒí‹° ìƒì„±</button>
        </div>

        <div id="partyList">
            <div class="empty-state">
                <p>íŒŒí‹° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </section>
</div>

<!-- íŒŒí‹°í¸ì„± ëª¨ë‹¬ -->
<div id="teamSetupModal" class="modal hidden">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>íŒŒí‹°í¸ì„±</h3>
            <button class="modal-close" onclick="closeTeamSetupModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="team-setup-section">
                <h4 id="teamFormTitle">ìƒˆ íŒ€ ë§Œë“¤ê¸°</h4>
                <div id="memberSelection" class="member-selection"></div>
                <div class="team-form-buttons">
                    <button id="btnSaveTeam" class="btn-submit" onclick="saveTeam()">íŒ€ ì¶”ê°€</button>
                    <button id="btnCancelEdit" class="btn-cancel hidden" onclick="cancelEditTeam()">ì·¨ì†Œ</button>
                </div>
            </div>
            <div class="team-list-section">
                <h4>í¸ì„±ëœ íŒ€ ëª©ë¡</h4>
                <div id="teamList" class="team-list"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="./js/supabase-config.js?v=20251218a"></script>
<script src="./js/combat-power.js?v=20251218a"></script>
<script src="./js/party-share.js?v=20251218a"></script>
<script src="./js/party-common.js?v=20251218a"></script>
<script>
// ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
PartyShare.initKakaoSDK('8e0f458671cc8e81c30125532b95a245');

// í˜„ì¬ íŒŒí‹° ëª©ë¡
let currentParties = [];

// íŒŒí‹° ëª©ë¡ ë¡œë“œ
async function loadParties() {
    const { data: parties, error } = await supabase
        .from('help_parties')
        .select(`*, help_members (*), help_teams (id)`)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error loading parties:', error);
        document.getElementById('partyList').innerHTML = PartyCommon.renderErrorState(error.message);
        return;
    }

    // ê° íŒŒí‹°ì— íŒ€ ìˆ˜ ì¶”ê°€
    const partiesWithTeamCount = (parties || []).map(party => ({
        ...party,
        team_count: party.help_teams ? party.help_teams.length : 0
    }));

    currentParties = partiesWithTeamCount;
    renderParties(partiesWithTeamCount);
}

// íŒŒí‹° ë Œë”ë§
function renderParties(parties) {
    const container = document.getElementById('partyList');

    if (!parties || parties.length === 0) {
        container.innerHTML = PartyCommon.renderEmptyState();
        return;
    }

    const sortedParties = PartyCommon.sortParties(parties);

    container.innerHTML = sortedParties.map(party => {
        const scheduleDate = party.schedule ? new Date(party.schedule) : null;
        const scheduleDisplay = scheduleDate ? PartyCommon.formatSchedule(scheduleDate) : '-';
        const timeRemaining = scheduleDate ? PartyCommon.getTimeRemaining(scheduleDate) : '';

        return `
        <div class="party-card" id="party-${party.id}" data-schedule="${party.schedule || ''}">
            <div class="party-header">
                <div class="party-header-info">
                    <span class="party-schedule">${scheduleDisplay}</span>
                    <span class="time-remaining">${timeRemaining}</span>
                </div>
                <div class="party-header-info">
                    <span class="party-count">${party.help_members.length}/4</span>
                    <span class="party-difficulty">${party.difficulty || 'ë§¤ìš° ì–´ë ¤ì›€'}</span>
                </div>
            </div>
            <div class="members-list">
                ${party.help_members.map(member => `
                    <div class="member-row-help">
                        <div>
                            <span class="member-label">ë³¸ìº</span>
                            <span class="member-nickname main-char">${member.main_nickname}</span>
                            <span class="member-class">${member.main_class || ''}</span>
                        </div>
                        <div>
                            <span class="member-label">íˆ¬ë ¥</span>
                            <span class="member-power">${PartyCommon.formatPowerShort(member.main_power)}</span>
                        </div>
                        ${member.is_main_only ? `
                            <div>
                                <span class="member-label">ë¶€ìº</span>
                                <span class="main-only-text">ë³¸ìºë§Œ ì°¸ì—¬</span>
                            </div>
                            <div></div>
                        ` : `
                            <div>
                                <span class="member-label">ë¶€ìº</span>
                                <span class="member-nickname sub-char">${member.sub_nickname || '-'}</span>
                                <span class="member-class">${member.sub_class || ''}</span>
                            </div>
                            <div>
                                <span class="member-label">íˆ¬ë ¥</span>
                                <span class="member-power">${PartyCommon.formatPowerShort(member.sub_power)}</span>
                            </div>
                        `}
                        <button class="btn-delete" onclick="deleteMember('${member.id}')">ì‚­ì œ</button>
                    </div>
                `).join('')}
            </div>
            <div class="party-actions">
                ${party.help_members.length < 4
                    ? `<button class="btn-add-member" onclick="PartyCommon.toggleAddMemberForm('${party.id}')">+ ì°¸ê°€í•˜ê¸°</button>`
                    : '<span style="color: #4ade80; font-size: 0.85rem;">íŒŒí‹° ëª¨ì§‘ ì™„ë£Œ!</span>'}
                <div class="share-container">
                    <button class="btn-share" onclick="PartyShare.toggleShareDropdown('${party.id}')">ê³µìœ </button>
                    <div id="shareDropdown-${party.id}" class="share-dropdown hidden">
                        <div class="share-option kakao" onclick="shareToKakaoWrapper('${party.id}')">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</div>
                        <div class="share-option clipboard" onclick="copyPartyInfoWrapper('${party.id}')">ğŸ“‹ í´ë¦½ë³´ë“œ</div>
                    </div>
                </div>
                <button class="btn-team-setup" onclick="openTeamSetupModal('${party.id}')">íŒŒí‹°í¸ì„±${party.team_count > 0 ? ` (${party.team_count})` : ''}</button>
                <button class="btn-delete-party" onclick="deleteParty('${party.id}')">íŒŒí‹° ì‚­ì œ</button>
            </div>
            <div id="addMemberForm-${party.id}" class="add-member-form hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>ë³¸ìº ë‹‰ë„¤ì„</label>
                        <input type="text" id="mainNickname-${party.id}" placeholder="ë³¸ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('mainNickname-${party.id}', 'mainPower-${party.id}', 'mainClass-${party.id}')">
                    </div>
                    <div class="form-group" style="max-width: 120px;">
                        <label>ë³¸ìº íˆ¬ë ¥</label>
                        <input type="number" id="mainPower-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                    <div class="form-group" style="max-width: 100px;">
                        <label>ë³¸ìº í´ë˜ìŠ¤</label>
                        <input type="text" id="mainClass-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                    </div>
                </div>
                <div class="form-row" style="margin: 10px 0;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="mainOnly-${party.id}" onchange="toggleSubCharSection('${party.id}')">
                        <span>ë³¸ìºë§Œ ì°¸ì—¬</span>
                    </label>
                </div>
                <div id="subCharSection-${party.id}">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ë¶€ìº ë‹‰ë„¤ì„</label>
                            <input type="text" id="subNickname-${party.id}" placeholder="ë¶€ìº ë‹‰ë„¤ì„" onkeydown="handleNicknameKeydown(event)" onblur="fetchCombatPower('subNickname-${party.id}', 'subPower-${party.id}', 'subClass-${party.id}')">
                        </div>
                        <div class="form-group" style="max-width: 120px;">
                            <label>ë¶€ìº íˆ¬ë ¥</label>
                            <input type="number" id="subPower-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                        </div>
                        <div class="form-group" style="max-width: 100px;">
                            <label>ë¶€ìº í´ë˜ìŠ¤</label>
                            <input type="text" id="subClass-${party.id}" placeholder="ìë™ì…ë ¥" readonly>
                        </div>
                    </div>
                </div>
                <button class="btn-submit" onclick="addMember('${party.id}')" style="padding: 8px 20px; font-size: 0.9rem;">ì°¸ê°€</button>
            </div>
        </div>
    `;
    }).join('');
}

// íŒŒí‹° ìƒì„±
async function createParty() {
    const difficulty = document.getElementById('newDifficulty').value;
    const mainNickname = document.getElementById('newMainNickname').value.trim();
    const mainPower = document.getElementById('newMainPower').value;
    const mainClass = document.getElementById('newMainClass').value.trim();
    const isMainOnly = document.getElementById('newMainOnly').checked;
    const subNickname = document.getElementById('newSubNickname').value.trim();
    const subPower = document.getElementById('newSubPower').value;
    const subClass = document.getElementById('newSubClass').value.trim();

    // ë³¸ìº í•„ìˆ˜ ì…ë ¥ í™•ì¸
    if (!PartyCommon.getSelectedScheduleDate() || !mainNickname || !mainPower || !mainClass) {
        alert2('ìš”ì¼Â·ì‹œê°„, ë³¸ìº ë‹‰ë„¤ì„, ì „íˆ¬ë ¥, í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¶€ìº í•„ìˆ˜ ì…ë ¥ í™•ì¸ (ë³¸ìºë§Œ ì°¸ì—¬ê°€ ì•„ë‹Œ ê²½ìš°)
    if (!isMainOnly && (!subNickname || !subPower || !subClass)) {
        alert2('ë¶€ìº ë‹‰ë„¤ì„, ì „íˆ¬ë ¥, í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë³¸ìºì™€ ë¶€ìº ë‹‰ë„¤ì„ ë™ì¼ ì—¬ë¶€ í™•ì¸
    if (!isMainOnly && mainNickname === subNickname) {
        alert2('ë³¸ìºì™€ ë¶€ìº ë‹‰ë„¤ì„ì€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const schedule = PartyCommon.getSelectedScheduleDate().toISOString();

    const { data: party, error: partyError } = await supabase
        .from('help_parties')
        .insert({ schedule, difficulty })
        .select()
        .single();

    if (partyError) {
        alert2('íŒŒí‹° ìƒì„± ì‹¤íŒ¨: ' + partyError.message, 'error');
        return;
    }

    const { error: memberError } = await supabase
        .from('help_members')
        .insert({
            party_id: party.id,
            main_nickname: mainNickname,
            main_power: mainPower ? parseInt(mainPower, 10) : null,
            main_class: mainClass || null,
            sub_nickname: isMainOnly ? null : subNickname,
            sub_power: isMainOnly ? null : (subPower ? parseInt(subPower, 10) : null),
            sub_class: isMainOnly ? null : (subClass || null),
            is_main_only: isMainOnly
        });

    if (memberError) {
        alert2('ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + memberError.message, 'error');
        return;
    }

    // í¼ ì´ˆê¸°í™”
    PartyCommon.clearScheduleDate();
    document.getElementById('newDifficulty').value = 'ë§¤ìš° ì–´ë ¤ì›€';
    document.getElementById('newMainNickname').value = '';
    document.getElementById('newMainPower').value = '';
    document.getElementById('newMainClass').value = '';
    document.getElementById('newMainOnly').checked = false;
    document.getElementById('subCharSection-new').classList.remove('hidden');
    document.getElementById('newSubNickname').value = '';
    document.getElementById('newSubPower').value = '';
    document.getElementById('newSubClass').value = '';
    document.getElementById('newPartyForm').classList.add('hidden');

    loadParties();
}

// ë©¤ë²„ ì¶”ê°€
async function addMember(partyId) {
    const mainNickname = document.getElementById(`mainNickname-${partyId}`).value.trim();
    const mainPower = document.getElementById(`mainPower-${partyId}`).value;
    const mainClass = document.getElementById(`mainClass-${partyId}`).value.trim();
    const isMainOnly = document.getElementById(`mainOnly-${partyId}`).checked;
    const subNickname = document.getElementById(`subNickname-${partyId}`).value.trim();
    const subPower = document.getElementById(`subPower-${partyId}`).value;
    const subClass = document.getElementById(`subClass-${partyId}`).value.trim();

    // ë³¸ìº í•„ìˆ˜ ì…ë ¥ í™•ì¸
    if (!mainNickname || !mainPower || !mainClass) {
        alert2('ë³¸ìº ë‹‰ë„¤ì„, ì „íˆ¬ë ¥, í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¶€ìº í•„ìˆ˜ ì…ë ¥ í™•ì¸ (ë³¸ìºë§Œ ì°¸ì—¬ê°€ ì•„ë‹Œ ê²½ìš°)
    if (!isMainOnly && (!subNickname || !subPower || !subClass)) {
        alert2('ë¶€ìº ë‹‰ë„¤ì„, ì „íˆ¬ë ¥, í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë³¸ìºì™€ ë¶€ìº ë‹‰ë„¤ì„ ë™ì¼ ì—¬ë¶€ í™•ì¸
    if (!isMainOnly && mainNickname === subNickname) {
        alert2('ë³¸ìºì™€ ë¶€ìº ë‹‰ë„¤ì„ì€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const party = currentParties.find(p => p.id === partyId);
    if (party && party.help_members.some(m => m.main_nickname === mainNickname || (!isMainOnly && m.sub_nickname === subNickname))) {
        alert2('ì´ë¯¸ ì°¸ê°€í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
        return;
    }

    const { error } = await supabase
        .from('help_members')
        .insert({
            party_id: partyId,
            main_nickname: mainNickname,
            main_power: mainPower ? parseInt(mainPower, 10) : null,
            main_class: mainClass || null,
            sub_nickname: isMainOnly ? null : subNickname,
            sub_power: isMainOnly ? null : (subPower ? parseInt(subPower, 10) : null),
            sub_class: isMainOnly ? null : (subClass || null),
            is_main_only: isMainOnly
        });

    if (error) {
        alert2('ì°¸ê°€ ì‹¤íŒ¨: ' + error.message, 'error');
        return;
    }

    loadParties();
}

// ë©¤ë²„ ì‚­ì œ
async function deleteMember(memberId) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('help_members')
        .delete()
        .eq('id', memberId);

    if (error) {
        alert2('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
        return;
    }

    loadParties();
}

// íŒŒí‹° ì‚­ì œ
async function deleteParty(partyId) {
    if (!confirm('íŒŒí‹° ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('help_parties')
        .delete()
        .eq('id', partyId);

    if (error) {
        alert2('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
        return;
    }

    loadParties();
}

// ë¶€ìº ì„¹ì…˜ í† ê¸€
function toggleSubCharSection(partyId) {
    const checkboxId = partyId === 'new' ? 'newMainOnly' : `mainOnly-${partyId}`;
    const sectionId = partyId === 'new' ? 'subCharSection-new' : `subCharSection-${partyId}`;
    const checkbox = document.getElementById(checkboxId);
    const section = document.getElementById(sectionId);

    if (checkbox.checked) {
        section.classList.add('hidden');
        // ë¶€ìº í•„ë“œ ì´ˆê¸°í™”
        if (partyId === 'new') {
            document.getElementById('newSubNickname').value = '';
            document.getElementById('newSubPower').value = '';
            document.getElementById('newSubClass').value = '';
        } else {
            document.getElementById(`subNickname-${partyId}`).value = '';
            document.getElementById(`subPower-${partyId}`).value = '';
            document.getElementById(`subClass-${partyId}`).value = '';
        }
    } else {
        section.classList.remove('hidden');
    }
}

// ========================================
// íŒŒí‹°í¸ì„± ê´€ë ¨ í•¨ìˆ˜
// ========================================
let currentTeamSetupPartyId = null;
let editingTeamId = null;  // í¸ì§‘ ì¤‘ì¸ íŒ€ ID

// íŒŒí‹°í¸ì„± ëª¨ë‹¬ ì—´ê¸°
async function openTeamSetupModal(partyId) {
    currentTeamSetupPartyId = partyId;
    const party = currentParties.find(p => p.id === partyId);
    if (!party) return;

    renderMemberSelection(party.help_members);
    await loadTeams(partyId);

    document.getElementById('teamSetupModal').classList.remove('hidden');
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeTeamSetupModal() {
    document.getElementById('teamSetupModal').classList.add('hidden');
    currentTeamSetupPartyId = null;
    cancelEditTeam();  // í¸ì§‘ ìƒíƒœ ì´ˆê¸°í™”
}

// ë©¤ë²„ ì„ íƒ ëª©ë¡ ë Œë”ë§ (ë³¸ìº/ë¶€ìº ê°œë³„ ì„ íƒ)
function renderMemberSelection(members) {
    const container = document.getElementById('memberSelection');
    if (members.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">ë“±ë¡ëœ íŒŒí‹°ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    let html = '';
    members.forEach(member => {
        // ë³¸ìº í•­ëª©
        html += `
            <label class="member-checkbox">
                <input type="checkbox" value="${member.id}" data-char-type="main" data-nickname="${member.main_nickname}">
                <span class="member-info">
                    <span class="char-type-badge main">ë³¸ìº</span>
                    <span class="main-char">${member.main_nickname}</span>
                </span>
            </label>
        `;
        // ë¶€ìº í•­ëª© (ë³¸ìºë§Œ ì°¸ì—¬ê°€ ì•„ë‹Œ ê²½ìš°)
        if (!member.is_main_only && member.sub_nickname) {
            html += `
                <label class="member-checkbox">
                    <input type="checkbox" value="${member.id}" data-char-type="sub" data-nickname="${member.sub_nickname}">
                    <span class="member-info">
                        <span class="char-type-badge sub">ë¶€ìº</span>
                        <span class="sub-char">${member.sub_nickname}</span>
                    </span>
                </label>
            `;
        }
    });
    container.innerHTML = html;
}

// íŒ€ ì €ì¥ (ìƒì„± ë˜ëŠ” ìˆ˜ì •)
async function saveTeam() {
    const checkboxes = document.querySelectorAll('#memberSelection input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        alert2('ìµœì†Œ 1ëª… ì´ìƒì˜ íŒŒí‹°ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ì„ íƒëœ ë©¤ë²„ ì •ë³´ ìˆ˜ì§‘ (member_id + char_type)
    const selectedMembers = Array.from(checkboxes).map(cb => ({
        memberId: cb.value,
        charType: cb.dataset.charType,
        nickname: cb.dataset.nickname
    }));

    // ê°™ì€ ìºë¦­í„° ì¤‘ë³µ ì²´í¬ (member_id + char_type ì¡°í•©)
    const uniqueKeys = selectedMembers.map(m => `${m.memberId}-${m.charType}`);
    if (new Set(uniqueKeys).size !== uniqueKeys.length) {
        alert2('ê°™ì€ íŒ€ì— ë™ì¼í•œ ìºë¦­í„°ë¥¼ ì¤‘ë³µ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let teamId;

    if (editingTeamId) {
        // í¸ì§‘ ëª¨ë“œ: ê¸°ì¡´ ë©¤ë²„ ì‚­ì œ í›„ ìƒˆë¡œ ì¶”ê°€
        teamId = editingTeamId;

        // ê¸°ì¡´ íŒ€ ë©¤ë²„ ì‚­ì œ
        const { error: deleteError } = await supabase
            .from('help_team_members')
            .delete()
            .eq('team_id', teamId);

        if (deleteError) {
            alert2('íŒ€ ìˆ˜ì • ì‹¤íŒ¨: ' + deleteError.message, 'error');
            return;
        }
    } else {
        // ìƒì„± ëª¨ë“œ: ìƒˆ íŒ€ ìƒì„±
        const { data: team, error: teamError } = await supabase
            .from('help_teams')
            .insert({ party_id: currentTeamSetupPartyId })
            .select()
            .single();

        if (teamError) {
            alert2('íŒ€ ìƒì„± ì‹¤íŒ¨: ' + teamError.message, 'error');
            return;
        }
        teamId = team.id;
    }

    // íŒ€-ë©¤ë²„ ì—°ê²° (char_type í¬í•¨)
    const teamMembers = selectedMembers.map(m => ({
        team_id: teamId,
        member_id: m.memberId,
        char_type: m.charType
    }));

    const { error: memberError } = await supabase
        .from('help_team_members')
        .insert(teamMembers);

    if (memberError) {
        alert2('íŒ€ ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + memberError.message, 'error');
        return;
    }

    // í¸ì§‘ ëª¨ë“œ ì´ˆê¸°í™”
    cancelEditTeam();

    // íŒ€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    await loadTeams(currentTeamSetupPartyId);

    // íŒŒí‹° ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (íŒ€ ìˆ˜ ì—…ë°ì´íŠ¸)
    await loadParties();
}

// íŒ€ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
async function editTeam(teamId) {
    editingTeamId = teamId;

    // íŒ€ ë°ì´í„° ë¡œë“œ
    const { data: team, error } = await supabase
        .from('help_teams')
        .select(`
            *,
            help_team_members (
                member_id,
                char_type
            )
        `)
        .eq('id', teamId)
        .single();

    if (error) {
        alert2('íŒ€ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
        return;
    }

    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
    document.querySelectorAll('#memberSelection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });

    // íŒ€ ë©¤ë²„ì— í•´ë‹¹í•˜ëŠ” ì²´í¬ë°•ìŠ¤ ì²´í¬
    team.help_team_members.forEach(tm => {
        const checkbox = document.querySelector(
            `#memberSelection input[value="${tm.member_id}"][data-char-type="${tm.char_type}"]`
        );
        if (checkbox) {
            checkbox.checked = true;
        }
    });

    // UI ì—…ë°ì´íŠ¸ (í¸ì§‘ ëª¨ë“œ)
    document.getElementById('teamFormTitle').textContent = 'íŒ€ ìˆ˜ì •';
    document.getElementById('btnSaveTeam').textContent = 'ìˆ˜ì •';
    document.getElementById('btnCancelEdit').classList.remove('hidden');
}

// íŒ€ í¸ì§‘ ì·¨ì†Œ (í¼ ì´ˆê¸°í™”)
function cancelEditTeam() {
    editingTeamId = null;

    // ì²´í¬ë°•ìŠ¤ ëª¨ë‘ í•´ì œ
    document.querySelectorAll('#memberSelection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });

    // UI ì´ˆê¸°í™” (ìƒì„± ëª¨ë“œ)
    document.getElementById('teamFormTitle').textContent = 'ìƒˆ íŒ€ ë§Œë“¤ê¸°';
    document.getElementById('btnSaveTeam').textContent = 'íŒ€ ì¶”ê°€';
    document.getElementById('btnCancelEdit').classList.add('hidden');
}

// íŒ€ ëª©ë¡ ë¡œë“œ
async function loadTeams(partyId) {
    const { data: teams, error } = await supabase
        .from('help_teams')
        .select(`
            *,
            help_team_members (
                id,
                member_id,
                char_type,
                help_members (
                    main_nickname,
                    sub_nickname,
                    is_main_only
                )
            )
        `)
        .eq('party_id', partyId)
        .order('created_at', { ascending: true });

    if (error) {
        console.error('íŒ€ ë¡œë“œ ì‹¤íŒ¨:', error);
        return;
    }

    renderTeamList(teams || []);
}

// íŒ€ ëª©ë¡ ë Œë”ë§
function renderTeamList(teams) {
    const container = document.getElementById('teamList');

    if (teams.length === 0) {
        container.innerHTML = '<p class="empty-team-text">í¸ì„±ëœ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    container.innerHTML = teams.map((team, index) => `
        <div class="team-card">
            <div class="team-header">
                <span class="team-number">${index + 1}íŒ€</span>
                <div class="team-header-buttons">
                    <button class="btn-edit-small" onclick="editTeam('${team.id}')">í¸ì§‘</button>
                    <button class="btn-delete-small" onclick="deleteTeam('${team.id}')">ì‚­ì œ</button>
                </div>
            </div>
            <div class="team-members">
                ${team.help_team_members.map(tm => {
                    const member = tm.help_members;
                    const charType = tm.char_type || 'main';
                    const nickname = charType === 'sub' ? member.sub_nickname : member.main_nickname;
                    const charClass = charType === 'sub' ? 'sub-char' : 'main-char';
                    const typeBadge = charType === 'sub' ? 'ë¶€' : 'ë³¸';
                    return `
                        <div class="team-member-item">
                            <span class="char-type-badge-small ${charType}">${typeBadge}</span>
                            <span class="${charClass}">${nickname}</span>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
}

// íŒ€ ì‚­ì œ
async function deleteTeam(teamId) {
    if (!confirm('ì´ íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { error } = await supabase
        .from('help_teams')
        .delete()
        .eq('id', teamId);

    if (error) {
        alert2('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
        return;
    }

    await loadTeams(currentTeamSetupPartyId);
    await loadParties();
}

// ê³µìœ  ë˜í¼
function copyPartyInfoWrapper(partyId) {
    const party = currentParties.find(p => p.id === partyId);
    if (!party) {
        alert2('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    const { text } = PartyShare.generatePartyText(party, 'help');
    PartyShare.copyToClipboard(text);
}

function shareToKakaoWrapper(partyId) {
    const party = currentParties.find(p => p.id === partyId);
    if (!party) {
        alert2('íŒŒí‹° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    PartyShare.shareToKakao(party, 'help');
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
    await PartyCommon.deleteExpiredParties('help_parties');
    loadParties();
    PartyCommon.initSchedulePicker('#newSchedule', 21);

    setInterval(async () => {
        await PartyCommon.deleteExpiredParties('help_parties');
        PartyCommon.updateTimeRemaining();
    }, 60000);
});
</script>
</body>
</html>
